[In English](https://github.com/VladimirKalachikhin/Galadriel-cache/blob/master/mapsources/mapsources.md)  
# Источники карт для GaladrielCache
Файлы в каталоге `mapsources/` являются источником сведений о карте и содержат параметры и функции, нужные для получения тайлов и обслуживания кеша соответствующей карты.

## Название карты и файл описания карты
Имя файла описания карты состоит из названия карты и расширения .php Это файл программы на PHP, и в нём должен соблюдаться синтаксис языка.
Название карты является также именем каталога с файлами тайлов карты.
В файле описания карты ничего не является обязательным. Вместо отсутствующих значений будут применены умолчальные.

## Переменные в файле описания карты
Список применяемых в файле описания карты переменных находится в mapsources/VariablesList.php
НЕЛЬЗЯ как-то изменять этот файл.  
Все переменные из этого файла являются глобальными.

## Хуки в файле описания карты
Хук -- это определяемая пользователем функция, вызываемая при определённых обстоятельствах. В файле описания карты эти функции обёрнуты в строку для избежания их определния там где в них нет необходимости и/или повторного определения.  
В хуках можно использовать полезные функции из fcommon.php 

### Функция для получения url тайла
```
function getURL($z,$x,$y,$getURLparams) {}
```
`$z` - масштаб  
`$x` - x координата тайла  
`$y` - y координата тайла  
`$getURLparams` - массив key => value с произвольными дополнительными параметрами, который может быть определён в файле описания карты.  
Если карта "версионная", т.е. имеются вариант или слой карты, то в `$getURLparams` передаётся строка с дополнительной частью url: `$getURLparams['mapAddPath'] = ....`
Пример можно посмотреть в `Wether.php`.

Функция `getURL()` должна возвращать либо строку - uri запроса на получение указанного тайла, либо массив из двух элементов:
строка - uri запроса на получение указанного тайла, и массив параметров для функции  [stream_context_create()](php.net/manual/en/context.php).  

### Функция получения тайла из локального хранилища
```
function getTileFile($r,$z,$x,$y) {}
```
`$r` - имя карты, может быть с путём к версии
`$z` - масштаб  
`$x` - x координата тайла  
`$y` - имя файла тайла, y координата и расширение  

Нормально тайлы хранятся в файловой системе в структуре каталогов `$tileCacheDir/mapName/z/x/y.ext`(mapName может содержать также версию или вариант карты: mapName/version). Функция `getTileFile()` даёт возможность получить тайл не из обычного тайлового хранилища, а откуда-то ещё. Если эта функция описана в файле описания карты, GaladrielCache будет пытаться получить тайл с помощью её вызова, а не от файловой системы.  

В настоящее время имеется поддержка только получения тайлов из файлов формате .mbtiles. В этом случае файл описания карты может состоять только из:
```
$functionGetTile = <<<'EOFU'
function getTile($r,$z,$x,$y){
	require_once('MBTilesClient.php');
	return serveMBTiles($r,$z,$x,$y);
} // end function getTile
EOFU;
```
Однако, практически полезно добавить человеческое название карты и минимальный и максимальный масштабы.  
Пример можно посмотреть в `world-coastline.php`  
Кроме того, для векторных тайлов необходимо указать
```
$ext = 'pbf';
$ContentType = 'application/x-protobuf';
$content_encoding = 'gzip';
```
и иметь файл стилей.  

Функция должна возвращать `array('img'=>$img)`, где `$img`  - это двоичная строка с изображением тайла, или `null`. Массив может содержать также любые переменные, например:  
`array('img'=>$img, 'ext'=>'png')`

## Функция для обработки изображения тайла
`function prepareTileImg($img)`  
`$img` - двоичная строка с изображением тайла  
Функция вызывается перед отсылкой изображения пользователю.  

Функция должна возвращать `array('img'=>$img)`, где `$img`  - это двоичная строка с изображением тайла, или `null`. Массив может содержать также любые переменные. Например, функция может менять формат изображения и возвращать ещё и новый mime type:  
`array('img'=>$img, 'ContentType'=>'image/jpeg')`  
Более полезный пример с обработкой изображения есть в `OpenTopoMap.php`.

### Javascript для GaladrielMap
Для взаимодействия с GaladrielMap в описании источника можно использовать массив
```
$data = array();
$data['javascriptOpen'] = ...; 	// строка javascript, выполняемая eval перед созданием карты
$data['javascriptClose'] = ...; 	// строка javascript, выполняемая eval перед закрытием карты
```
Пример есть в `Wether.php`.

## Векторные тайлы
 -- должны умереть. Очень кривой в реализации, очень ресурсоёмкий подход, полезный только правоторговцам.
 Однако, ограниченная поддержка имеется. Можно показывать векторные тайлы в формате MapBox .pbf
 Файл стиля .json должен иметь имя карты, и располагаться рядом с файлом описания источника карты.
 НО!!! Тупые пацаны, придумавшие формат MapBox, потребовали, чтобы в файле стиля были полные url ресурсов. Именно полные, относительный путь не поддерживается. Поэтому шрифты и значки лежат в каталоге GaladrielMap, и пути в каждом файле стиля должны указывать туда.
